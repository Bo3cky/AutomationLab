- name: Génération et déploiement de clef ssh
  hosts: all
  tasks:

  - name: Génération de clef
    openssh_keypair:
      path: /home/vagrant/vagrant
      type: rsa
      size: 4096
      state: present
      force: yes
    delegate_to: localhost
    run_once: yes

  - name: Création de l'utilisateur admin1
    user:
      name: admin1
      shell: /bin/bash
      groups: sudo
      append: yes
      password: "{{ 'password' | password_hash('sha512') }}"
    become: yes

  - name: Ajouter admin1 aux sudoers
    copy:
      dest: "/etc/sudoers.d/admin1"
      content: "devops ALL=(ALL) NOPASSWD: ALL"
    become: yes

  - name: Déploiement de la clé ssh
    authorized_key:
      user: admin1
      key: "{{ lookup('file', '/home/vagrant/vagrant.pub') }}"
    become: yes
   
